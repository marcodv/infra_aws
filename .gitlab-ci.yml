image: 
  name: $GITLAB_INFRA_REGISTRY/$INFRA_AWS/terraform:$TERRAFORM_VERSION
  entrypoint: 
    - '/usr/bin/env'
    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'

before_script:
  - 'export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_TEST_ENV' 
  - 'export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_TEST_ENV'

stages:
  #- lintsec
  #- validate
  - plan

#tfseclint:
#  stage: lintsec
#  image:
#    name: $GITLAB_INFRA_REGISTRY/$INFRA_AWS/tfsec:$TFSEC_VERSION
#    entrypoint: [""]
#  script:
#    - echo "Running security scanning on terraform project"
#    - tfsec .
#  allow_failure: true

#validate:
#  stage: validate
#  script: 
#    - terraform init 
#    - terraform validate

plan:
  stage: plan
  #needs: [validate]
  script: 
    - terraform init -backend-config="bucket=tfstate-infra-test"
    - terraform plan -out "planfile.json"
    - terraform show -json planfile.json > planfile_human.json
    - terraform apply -auto-approve
  artifacts:
    paths:
      - planfile_human.json
